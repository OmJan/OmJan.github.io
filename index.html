<!DOCTYPE html>
<html>
  <head>
    <title>OmJan page</title>
    <style type="text/css">
      html{ height: 100%; }
      body{ display: flex; flex-direction: column; height: 100%;}
      header{ flex: 0 0 auto; }
      .wrap-content{ flex: 1 0 auto; }
      .main-content {
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      .main-content section { width: 320px; }
      footer{ flex: 0 0 auto; }
      .st0{fill:black;}
      .st1{fill:green;}
      .st2{fill:white;}
      .multik {
        background-color: green;
        width: 320px;
        height: 500px;
      }
    </style>
  </head>
  <body>
    <header></header>
    <section class="wrap-content">
      <div class="main-content">
        <section>
          <!-- <div class="container">
            <a href="http://stackoverflow.com/users/4638004/janom?theme=clean">
              <img src="http://stackoverflow.com/users/flair/4638004.png" width="208" height="58" alt="profile for Janom at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Janom at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
            </a>
          </div> -->
        </section>
        <section>
          <button id="stop">Pause</button><button id="start">Start</button><button id="reset">Reset</button>
          <div class="multik">
            <svg xmlns="http://www.w3.org/2000/svg" id="solly" viewBox="0 0 320 500">
              <circle id="gameBall" class="st2" cx="305" cy="395" r="5"/>
              <!-- Start pipe -->
              <polyline points="26,156.77 27,148.93 28,143.34 29,138.76 30,134.80 31,131.27 32,128.06 33,125.10 34,122.34 35,119.76 36,117.32 37,115.01 38,112.81 39,110.70 40,108.69 41,106.75 42,104.89 43,103.10 44,101.36 45,99.69 46,98.06 47,96.49 48,94.96 49,93.48 50,92.03 51,90.63 52,89.26 53,87.93 54,86.63 55,85.36 56,84.12 57,82.91 58,81.73 59,80.58 60,79.45 61,78.35 62,77.27 63,76.21 64,75.18 65,74.17 66,73.18 67,72.20 68,71.25 69,70.32 70,69.41 71,68.51 72,67.63 73,66.77 74,65.93 75,65.10 76,64.29 77,63.49 78,62.71 79,61.94 80,61.19 81,60.46 82,59.73 83,59.02 84,58.33 85,57.64 86,56.97 87,56.32 88,55.67 89,55.04 90,54.42 91,53.81 92,53.21 93,52.63 94,52.06 95,51.49 96,50.94 97,50.40 98,49.87 99,49.35 100,48.84 101,48.34 102,47.86 103,47.38 104,46.91 105,46.45 106,46.00 107,45.57 108,45.14 109,44.72 110,44.31 111,43.90 112,43.51 113,43.13 114,42.76 115,42.39 116,42.04 117,41.69 118,41.35 119,41.02 120,40.70 121,40.39 122,40.08 123,39.78 124,39.50 125,39.22 126,38.95 127,38.68 128,38.43 129,38.18 130,37.94 131,37.71 132,37.49 133,37.27 134,37.07 135,36.87 136,36.68 137,36.49 138,36.32 139,36.15 140,35.99 141,35.84 142,35.69 143,35.55 144,35.42 145,35.30 146,35.19 147,35.08 148,34.98 149,34.89 150,34.80 151,34.72 152,34.65 153,34.59 154,34.53 155,34.49 156,34.45 157,34.41 158,34.39 159,34.37 160,34.36 161,34.35 162,34.36 163,34.37 164,34.39 165,34.41 166,34.45 167,34.49 168,34.53 169,34.59 170,34.65 171,34.72 172,34.80 173,34.89 174,34.98 175,35.08 176,35.19 177,35.30 178,35.42 179,35.55 180,35.69 181,35.84 182,35.99 183,36.15 184,36.32 185,36.49 186,36.68 187,36.87 188,37.07 189,37.27 190,37.49 191,37.71 192,37.94 193,38.18 194,38.43 195,38.68 196,38.95 197,39.22 198,39.50 199,39.78 200,40.08 201,40.39 202,40.70 203,41.02 204,41.35 205,41.69 206,42.04 207,42.39 208,42.76 209,43.13 210,43.51 211,43.90 212,44.31 213,44.72 214,45.14 215,45.57 216,46.00 217,46.45 218,46.91 219,47.38 220,47.86 221,48.34 222,48.84 223,49.35 224,49.87 225,50.40 226,50.94 227,51.49 228,52.06 229,52.63 230,53.21 231,53.81 232,54.42 233,55.04 234,55.67 235,56.32 236,56.97 237,57.64 238,58.33 239,59.02 240,59.73 241,60.46 242,61.19 243,61.94 244,62.71 245,63.49 246,64.29 247,65.10 248,65.93 249,66.77 250,67.63 251,68.51 252,69.41 253,70.32 254,71.25 255,72.20 256,73.18 257,74.17 258,75.18 259,76.21 260,77.27 261,78.35 262,79.45 263,80.58 264,81.73 265,82.91 266,84.12 267,85.36 268,86.63 269,87.93 270,89.26 271,90.63 272,92.03 273,93.48 274,94.96 275,96.49 276,98.06 277,99.69 278,101.36 279,103.10 280,104.89 281,106.75 282,108.69 283,110.70 284,112.81 285,115.01 286,117.32 287,119.76 288,122.34 289,125.10 290,128.06 291,131.27 292,134.80 293,138.76 294,143.34 295,148.93 296,156.77" fill="none" stroke-width="0.5" stroke="white"/>
              <!-- c = [(x,  (170 -(18400 - (x-161)**2)**(0.5) )  ) for x in xrange(0, 340) if (18400 - (x-161)**2) >  0] -->
              <polyline points="2,164.00 3,151.27 4,144.23 5,138.78 6,134.17 7,130.11 8,126.46 9,123.11 10,120.00 11,117.09 12,114.36 13,111.77 14,109.30 15,106.95 16,104.70 17,102.54 18,100.46 19,98.45 20,96.52 21,94.64 22,92.82 23,91.06 24,89.35 25,87.69 26,86.07 27,84.50 28,82.96 29,81.46 30,80.00 31,78.57 32,77.18 33,75.81 34,74.48 35,73.18 36,71.90 37,70.65 38,69.42 39,68.22 40,67.04 41,65.89 42,64.76 43,63.65 44,62.56 45,61.49 46,60.44 47,59.41 48,58.39 49,57.40 50,56.42 51,55.46 52,54.52 53,53.59 54,52.68 55,51.78 56,50.90 57,50.04 58,49.19 59,48.35 60,47.53 61,46.72 62,45.92 63,45.14 64,44.37 65,43.61 66,42.86 67,42.13 68,41.41 69,40.70 70,40.00 71,39.31 72,38.64 73,37.97 74,37.32 75,36.68 76,36.04 77,35.42 78,34.81 79,34.21 80,33.62 81,33.04 82,32.46 83,31.90 84,31.35 85,30.81 86,30.27 87,29.75 88,29.23 89,28.72 90,28.23 91,27.74 92,27.26 93,26.78 94,26.32 95,25.86 96,25.42 97,24.98 98,24.55 99,24.13 100,23.71 101,23.31 102,22.91 103,22.52 104,22.14 105,21.76 106,21.39 107,21.03 108,20.68 109,20.34 110,20.00 111,19.67 112,19.35 113,19.03 114,18.73 115,18.42 116,18.13 117,17.85 118,17.57 119,17.29 120,17.03 121,16.77 122,16.52 123,16.28 124,16.04 125,15.81 126,15.58 127,15.37 128,15.16 129,14.95 130,14.76 131,14.57 132,14.39 133,14.21 134,14.04 135,13.88 136,13.72 137,13.57 138,13.42 139,13.29 140,13.16 141,13.03 142,12.91 143,12.80 144,12.70 145,12.60 146,12.51 147,12.42 148,12.34 149,12.27 150,12.20 151,12.14 152,12.09 153,12.04 154,12.00 155,11.97 156,11.94 157,11.91 158,11.90 159,11.89 160,11.89 161,11.89 162,11.90 163,11.91 164,11.94 165,11.97 166,12.00 167,12.04 168,12.09 169,12.14 170,12.20 171,12.27 172,12.34 173,12.42 174,12.51 175,12.60 176,12.70 177,12.80 178,12.91 179,13.03 180,13.16 181,13.29 182,13.42 183,13.57 184,13.72 185,13.88 186,14.04 187,14.21 188,14.39 189,14.57 190,14.76 191,14.95 192,15.16 193,15.37 194,15.58 195,15.81 196,16.04 197,16.28 198,16.52 199,16.77 200,17.03 201,17.29 202,17.57 203,17.85 204,18.13 205,18.42 206,18.73 207,19.03 208,19.35 209,19.67 210,20.00 211,20.34 212,20.68 213,21.03 214,21.39 215,21.76 216,22.14 217,22.52 218,22.91 219,23.31 220,23.71 221,24.13 222,24.55 223,24.98 224,25.42 225,25.86 226,26.32 227,26.78 228,27.26 229,27.74 230,28.23 231,28.72 232,29.23 233,29.75 234,30.27 235,30.81 236,31.35 237,31.90 238,32.46 239,33.04 240,33.62 241,34.21 242,34.81 243,35.42 244,36.04 245,36.68 246,37.32 247,37.97 248,38.64 249,39.31 250,40.00 251,40.70 252,41.41 253,42.13 254,42.86 255,43.61 256,44.37 257,45.14 258,45.92 259,46.72 260,47.53 261,48.35 262,49.19 263,50.04 264,50.90 265,51.78 266,52.68 267,53.59 268,54.52 269,55.46 270,56.42 271,57.40 272,58.39 273,59.41 274,60.44 275,61.49 276,62.56 277,63.65 278,64.76 279,65.89 280,67.04 281,68.22 282,69.42 283,70.65 284,71.90 285,73.18 286,74.48 287,75.81 288,77.18 289,78.57 290,80.00 291,81.46 292,82.96 293,84.50 294,86.07 295,87.69 296,89.35 297,91.06 298,92.82 299,94.64 300,96.52 301,98.45 302,100.46 303,102.54 304,104.70 305,106.95 306,109.30 307,111.77 308,114.36 309,117.09 310,120.00 311,123.11 312,126.46 313,130.11 314,134.17 315,138.78" fill="none" stroke-width="0.5" stroke="white" />
              <!--c = (170 -(25000 - (x-160)**2)**(0.5) )  ) for x in xrange(0, 340) if ((25000 - (x-160)**2) >  0) and (x <= 315) and (x >= 5)] -->

              <polyline points="2,164.00 3,174.00 4,178.14 5,181.32 6,184.00 7,186.36 8,188.49 9,190.46 10,192.28 11,194.00 12,195.62 13,197.17 14,198.64 15,200.06 16,201.42 17,202.73 18,204.00 19,205.23 20,206.43 21,207.59 22,208.72 23,209.83 24,210.90 25,211.96 26,212.99 27,214.00 28,214.99 29,215.96 30,216.92 31,217.85 32,218.77 33,219.68 34,220.57 35,221.45 36,222.31 37,223.16 38,224.00 39,224.83 40,225.64 41,226.45 42,227.25 43,228.03 44,228.81 45,229.57 46,230.33 47,231.08 48,231.82 49,232.56 50,233.28 51,234.00 52,234.71 53,235.41 54,236.11 55,236.80 56,237.48 57,238.16 58,238.83 59,239.50 60,240.16" fill="none" stroke-width="0.5" stroke="white" />
              <!-- c = [(x, (10*(x-2)**0.5 + 164)  ) for x in xrange(0, 340) if (x <= 60) and (x >= 2)] -->

              <polyline points="296 395, 296, 157" fill="none" stroke-width="0.5" stroke="white"/>
              <polyline points="315 395, 315, 139" fill="none" stroke-width="0.5" stroke="white"/>
              <!--y = x*x/100 -3*x + 400 -->
              <!--y' = f(x') + (2*x'/100 - 3)(x-x')-->
              <!-- End start pipe -->

              <rect style="fill:#ccc;" id="spring" width="20" height="110" x="295" y="395" />
              <rect id="left-bat" width="90" height="10" ry="5" style="fill:grey;" x="60" y="395" transform="rotate(45 65 400)"/>
              <circle style="fill:white" cx="65" cy="400" r="5"/>
              <circle style="fill:grey" cx="65" cy="400" r="2"/>
              <rect id="right-bat" width="90" height="10" ry="5" style="fill:grey;" x="160" y="395" transform="rotate(-45 245 400)"/>
              <circle style="fill:white" cx="245" cy="400" r="5"/>
              <circle style="fill:grey" cx="245" cy="400" r="2"/>
            </svg>
          </div>
        </section>
        <section>
        </section>
      </div>
    </section>
    <footer>
      <nav>
        <ul>
          <li><a href="https://github.com/OmJan">Github</a></li>
        </ul>
      </nav>
    </footer>
    <script type="text/javascript">
      const OUT = 99999999999;
      const DELTA = 10;
      function getRandomArbitary(min, max) {
        return Math.random() * (max - min) + min;
      }


      const Spring = function () {
        const self = this;
        this.count = 0;
        this.animateSpring = function animateSpring() {
          self.count = self.count + 1;
          console.log(self.count);
        };
        this.startSpringTime = function startSpringTime() {
          self.count = 0;
          self.springInterval = setInterval(self.animateSpring, 100);
        };
        this.stopSprintTime = function stopSpringTime(e) {
          console.log(self.count);
          clearInterval(self.springInterval);
        };
      };

      const Barrier = function (xDiapason, yDiapason, func, getSpeedAfterBreak, limit=1) {
        const self = this;
        this.xDiapason = xDiapason;
        this.yDiapason = yDiapason;
        this.func = func; // must be function y(x) and get args x, y
        this.getSpeedAfterBreak = getSpeedAfterBreak; // function, args: x, y, ySpeedBefore, xSeedBefore
        this.checkBreak = function checkBreak(x, y) {
          let isBreak = false;
          if (y < self.yDiapason[1] && y > self.yDiapason[0]) {
            const yCalc = self.func(x, y);
            if (((Math.floor(y) - limit) <  Number((yCalc).toFixed(1))) && (Number((yCalc).toFixed(1)) < (Math.ceil(y) + limit))) {
              isBreak = true;
            } else {
              isBreak = false;
            }
            return isBreak;
          }
          return isBreak;
        };
      };


      const rPipeLine = new Barrier(
        [315, 315],
        [134, 395],
        function (x, y) {
          if (Math.floor(x) === 315 || Math.ceil(x) === 315) {
            return y;
          } else {
            return OUT;
          }
        },
        function (x, y, xSpeedBefore, ySpeedBefore) {
          return [-xSpeedBefore, ySpeedBefore];
        }
      );
      const leftPipeLine = new Barrier(
        [296, 296],
        [150, 395],
        function (x, y) {
          if (Math.floor(x) === 296 || Math.ceil(x) === 296) {
            return y;
          } else {
            return OUT;
          }
        },
        function (x, y, xSpeedBefore, ySpeedBefore) {
          return [-xSpeedBefore, ySpeedBefore];
        }
      );
      const upPipeArc = new Barrier(
        [5, 315],
        [10, 150],
        function (x, y) {
          // c = [(x,  (170 -(25000 - (x-160)**2)**(0.5) )  ) for x in xrange(0, 340) if ((25000 - (x-160)**2) >  0) and (x <= 315) and (x >= 5)]
          return (170 - Math.sqrt(25000 - Math.pow(x - 160, 2)) );
        },
        function (x, y, xSpeedBefore, ySpeedBefore) {
          const derivative = - (x - 160) / Math.sqrt(25000 - Math.pow(x - 160, 2));
          const tAngle = Math.atan(derivative);
          const vAngle = Math.atan(xSpeedBefore / ySpeedBefore);
          const diffAngle = Math.abs(Math.abs(tAngle < 0 ? (Math.PI + tAngle) : tAngle) - Math.abs(vAngle < 0 ? (Math.PI + vAngle) : vAngle));
          const normAngle = (diffAngle > Math.PI/2) ? (Math.PI - diffAngle) : diffAngle;
          const resAngle = normAngle*2;
          const xSpeedAfter = xSpeedBefore * Math.cos(resAngle) - ySpeedBefore * Math.sin(resAngle);
          const ySpeedAfter = xSpeedBefore * Math.sin(resAngle) + ySpeedBefore * Math.cos(resAngle);
          return [-xSpeedAfter*0.9, -ySpeedAfter*0.9];
        }
      );
      const bottomPipeArc = new Barrier(
        [5, 315],
        [5, 150],
        function (x, y) {
          // c = [(x,  (170 -(18400 - (x-161)**2)**(0.5) )  ) for x in xrange(0, 340) if (18400 - (x-161)**2) >  0]
          return (170 -Math.sqrt(18400 - Math.pow(x - 161, 2)) );
        },
        function (x, y, xSpeedBefore, ySpeedBefore) {
          const derivative = - (x - 161) / Math.sqrt(18400 - Math.pow(x - 161, 2));
          const tAngle = Math.atan(derivative);
          const vAngle = Math.atan(xSpeedBefore / ySpeedBefore);
          const diffAngle = Math.abs(Math.abs(tAngle < 0 ? (Math.PI + tAngle) : tAngle) - Math.abs(vAngle < 0 ? (Math.PI + vAngle) : vAngle));
          const normAngle = (diffAngle > Math.PI / 2) ? (Math.PI - diffAngle) : diffAngle;
          const resAngle = - normAngle*2;
          const xSpeedAfter = xSpeedBefore * Math.cos(resAngle) - ySpeedBefore * Math.sin(resAngle);
          const ySpeedAfter = xSpeedBefore * Math.sin(resAngle) + ySpeedBefore * Math.cos(resAngle);
          return [xSpeedAfter*0.9, ySpeedAfter*0.9];
        }
      );

      const bottomParabola = new Barrier(
        [2, 65],
        [160, 250],
        function (x, y) {
          // c = [(x, (10*(x-2)**0.5 + 164)  ) for x in xrange(0, 340) if (x <= 60) and (x >= 2)]
          return (164 + 10 * Math.sqrt(x - 2) );
        },
        function (x, y, xSpeedBefore, ySpeedBefore) {
          const derivative = 5 / Math.sqrt(x - 2);
          const tAngle = Math.atan(derivative);
          const vAngle = Math.atan(xSpeedBefore / ySpeedBefore);
          const diffAngle = Math.abs(Math.abs(tAngle < 0 ? (Math.PI + tAngle) : tAngle) - Math.abs(vAngle < 0 ? (Math.PI + vAngle) : vAngle));
          const normAngle = (diffAngle > Math.PI / 2) ? (Math.PI - diffAngle) : diffAngle;
          const resAngle = - normAngle*2;
          const xSpeedAfter = xSpeedBefore * Math.cos(resAngle) - ySpeedBefore * Math.sin(resAngle);
          const ySpeedAfter = xSpeedBefore * Math.sin(resAngle) + ySpeedBefore * Math.cos(resAngle);
          return [xSpeedAfter*0.7, ySpeedAfter*0.7];
        }
      );

      const barriers = [
        rPipeLine,
        leftPipeLine,
        upPipeArc,
        bottomPipeArc,
        bottomParabola
      ];


      const Ball = function () {
        const self = this;
        this.element = document.getElementById ( 'gameBall' );
        this.xSpeed = -0.02; // +0.02;
        this.ySpeed = -0.35;
        this.yAcceleration = 0.0001;
        this.xAcceleration = 0;
        this.delta = DELTA;
        // work with surfaces and power
        this.prevSurface = undefined;
        this.currentSurface = undefined;
        // this.x = getRandomArbitary(0, 250);
        this.x = 305;
        this.element.setAttribute ( "cx", 305);
        this.y = 395;
        this.element.setAttribute ( "cy", 395);
        this.bang = false;
        this.init = function init(stopFunc) {
          this.stopCallBack = stopFunc;
        };
        this.stopBall = function stopBall() {
          self.xSpeed = 0;
          self.ySpeed = 0;
          self.yAcceleration = 0;
          self.xAcceleration = 0;
          self.stopCallBack();
        };
        this.setNewSpeed = function setNewSpeed(xSpeed, ySpeed) {
          self.xSpeed = xSpeed;
          self.ySpeed = ySpeed;
        };
        this.getNewSpeed = function getNewSpeed() {
          self.xSpeed = self.xSpeed + self.xAcceleration * self.delta;
          self.ySpeed = self.ySpeed + self.yAcceleration * self.delta;
        };
        this.getNewPosition = function getNewPosition() {
          let cxNew, cyNew;
          const e = document.getElementById ( 'gameBall' );
          const cxPrev = self.element.getAttribute( 'cx' );
          const cyPrev = self.element.getAttribute( 'cy' );
          cyNew = parseFloat(cyPrev) + self.ySpeed * self.delta + self.yAcceleration * self.delta * self.delta / 2;
          cxNew = parseFloat(cxPrev) + self.xSpeed * self.delta + self.xAcceleration * self.delta * self.delta / 2;
          self.element.setAttribute ( "cx", cxNew );
          self.element.setAttribute ( "cy", cyNew );
          self.checkBreakPoint(cxNew, cyNew, self.xSpeed, self.ySpeed, self.setNewSpeed, self.getNewSpeed);
          // self.stopBall();
        };
        this.checkBreakPoint = function checkBreakPoint(x, y, xSpeedBefore, ySpeedBefore, breakSpeedFunc, simpleSpeedFunc) {
          let isBreak = false;
          for (let i in barriers) {
            if (barriers[i].checkBreak(x, y)) {
              isBreak = true;
              if (breakSpeedFunc) {
                breakSpeedFunc.apply(self, barriers[i].getSpeedAfterBreak(x, y, xSpeedBefore, ySpeedBefore));
                self.prevSurface = i;
              }
              // self.stopBall();
              break;
            }
          }
          // check if in bat zone
          if (x <= 245 && x >= 60 && y <=470 && y>= 330) {
            const rightBatBarrier = rightBat.getCurrentBarrier();
            const leftBatBarrier = leftBat.getCurrentBarrier();
            if (rightBatBarrier.checkBreak(x, y)) {
              isBreak = true;
              breakSpeedFunc.apply(self, rightBatBarrier.getSpeedAfterBreak(x, y, xSpeedBefore, ySpeedBefore));
            } else if (leftBatBarrier.checkBreak(x, y)) {
              isBreak = true;
              breakSpeedFunc.apply(self, leftBatBarrier.getSpeedAfterBreak(x, y, xSpeedBefore, ySpeedBefore));
            }
          }
          if (isBreak == false) {
            simpleSpeedFunc();
          }
          return isBreak;
        };
      };


      const Game = function () {
        const self = this;
        this.animate = function animate() {
          self.gameBall.getNewPosition();
        };
        this.play = function play() {
          const gameBall = new Ball();
          gameBall.init(self.stop);
          self.gameBall = gameBall;
          self.animateInterval = setInterval(self.animate, DELTA);
        };
        this.stop = function stop() {
          clearInterval(self.animateInterval);
        };
        this.start = function start() {
          self.animateInterval = setInterval(self.animate, DELTA);
        };
        this.reset = function reset() {
          clearInterval(self.animateInterval);
          delete self.gameBall;
          const gameBall = new Ball();
          self.gameBall = gameBall;
          self.animateInterval = setInterval(self.animate, DELTA);
        };
      };


      const game = new Game();
      game.play();

      const stop = document.getElementById('stop');
      const start = document.getElementById('start');
      const reset = document.getElementById('reset');
      stop.onclick = game.stop;
      start.onclick = game.start;
      reset.onclick = game.reset;

      const gameSpring = new Spring();
      const spring = document.getElementById('spring');
      spring.onmousedown = gameSpring.startSpringTime;
      spring.onmouseup = gameSpring.stopSprintTime;


      const Bat = function (element, clockwise=true) {
        // <rect id="left-bat" width="90" height="10" ry="5" style="fill:white;" x="60" y="400" transform="rotate(-35 65 400)"/>
        const self = this;
        this.element = element;
        this.clockwise = clockwise;
        if (clockwise) {
          this.speed = 5;
        } else {
          this.speed = -5;
        }
        this.angleDiapason = [-45, 45];
        this.power = false; // if power off, animate bottom splice
        this.init = function init() {
          const transform = self.element.getAttribute('transform');
          const args = transform.split("(")[1].split(')')[0].split(" ").map(parseFloat);
          self.angle = args[0];
          self.xRotate = args[1];
          self.yRotate = args[2];
        };
        this.getCurrentBarrier = function getCurrentBarrier() {
          const angle = self.angle * Math.PI / 180;
          const tan = Math.tan(angle);
          const y2 = Math.sin(angle) * 90;
          const x2 = Math.cos(angle) * 90;
          const b = self.yRotate - tan * self.xRotate;
          const batPosition = new Barrier(
            [Math.min(self.xRotate, x2), Math.max(self.xRotate, x2)],
            [Math.min(self.yRotate, y2), Math.max(self.yRotate, y2)],
            function (x, y) {
              const y1 = tan * x + b;
              return y1;
            },
            function (x, y, xSpeedBefore, ySpeedBefore) {
              const tAngle = angle;
              const vAngle = Math.atan(xSpeedBefore / ySpeedBefore);
              const diffAngle = Math.abs(Math.abs(tAngle < 0 ? (Math.PI + tAngle) : tAngle) - Math.abs(vAngle < 0 ? (Math.PI + vAngle) : vAngle));
              const normAngle = (diffAngle > Math.PI / 2) ? (Math.PI - diffAngle) : diffAngle;
              const resAngle = normAngle*2;
              const xSpeedAfter = xSpeedBefore * Math.cos(resAngle) - ySpeedBefore * Math.sin(resAngle);
              const ySpeedAfter = xSpeedBefore * Math.sin(resAngle) + ySpeedBefore * Math.cos(resAngle);
              return [xSpeedAfter, ySpeedAfter];
            },
            3
          );
          return batPosition;
        };
        this.setPower = function setPower() {
          self.power = true;
        };

        this.zeroPower = function zeroPower() {
          self.power = false;
        };
        this.getNewPosition = function getNewPosition() {
          if (!self.power) {
            // calc position
            self.angle = self.angle + self.speed;
            if (Math.abs(self.angle) >= 45) {
              if (self.clockwise) {
                self.angle = 45;
              } else {
                self.angle = -45;
              }
            }
            self.element.setAttribute('transform', 'rotate(' + self.angle + ' ' + self.xRotate + ' ' + self.yRotate + ')');
          } else {
            self.angle = self.angle - self.speed;
            if (self.clockwise) {
              self.angle = Math.max(self.angleDiapason[0], self.angle);
            } else {
              self.angle = Math.min(self.angleDiapason[1], self.angle);
            }
            self.element.setAttribute('transform', 'rotate(' + self.angle + ' ' + self.xRotate + ' ' + self.yRotate + ')');
          }
        };
        this.play = function play() {
          self.timer = setInterval(self.getNewPosition, DELTA);
        };
        this.stop = function stop(e) {
          clearInterval(self.timer);
        };
      };

      const leftBatElement = document.getElementById('left-bat');
      const rightBatElement = document.getElementById('right-bat');
      const leftBat = new Bat(leftBatElement, true);
      const rightBat = new Bat(rightBatElement, false);
      document.onkeydown = function (e) {
        if (e.keyCode === 65) {
          leftBat.setPower();
        } else if (e.keyCode === 68) {
          rightBat.setPower();
        }
      };
      document.onkeyup = function (e) {
        if (e.keyCode === 65) {
          leftBat.zeroPower();
        } else if (e.keyCode === 68) {
          rightBat.zeroPower();
        }
      };
      leftBat.init();
      rightBat.init();
      leftBat.play();
      rightBat.play();
    </script>
  </body>
</html>
